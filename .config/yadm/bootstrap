#!/usr/bin/env bash
set -euo pipefail

echo "=== Starting yadm bootstrap ==="

# Detect OS
OS=$(uname -s)
echo "Detected OS: $OS"

# macOS-specific: Xcode Command Line Tools
if [[ "$OS" == "Darwin" ]]; then
  if ! xcode-select -p >/dev/null 2>&1; then
    echo "Installing Xcode Command Line Tools..."
    xcode-select --install || true
    # wait until installed (best-effort)
    until xcode-select -p >/dev/null 2>&1; do sleep 2; done
  fi
fi

# 1) Homebrew (install if missing, then load into PATH for this run)
if ! command -v brew >/dev/null 2>&1; then
  echo "Installing Homebrew..."
  /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
fi

# Load Homebrew into PATH (different paths for macOS vs Linux)
if [[ "$OS" == "Darwin" ]]; then
  eval "$(/opt/homebrew/bin/brew shellenv 2>/dev/null || /usr/local/bin/brew shellenv)"
else
  eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
fi
echo "Homebrew: $(brew --version | head -1)"

# macOS ARM-specific: Rosetta
if [[ "$OS" == "Darwin" && "$(uname -m)" == "arm64" ]]; then
  /usr/sbin/softwareupdate --install-rosetta --agree-to-license >/dev/null 2>&1 || true
fi

# 2) Ubuntu/Debian-specific: System packages FIRST
if [[ "$OS" == "Linux" ]] && command -v apt >/dev/null 2>&1; then
  echo "Installing Ubuntu system packages..."

  sudo apt update
  sudo apt install -y \
    build-essential \
    curl \
    git \
    wget \
    unzip \
    zsh \
    fontconfig \
    libgtk-4-dev \
    libadwaita-1-dev \
    fonts-powerline \
    gnome-shell-extensions \
    gnome-tweaks \
    chrome-gnome-shell \
    dconf-cli

  echo "✓ System packages installed"
fi

# 3) yadm alternates - Run EARLY to create .zshrc from template
echo "Applying yadm alternates..."
yadm alt   || true   # apply os/host alternates
yadm perms || true   # fix ~/.ssh perms etc.
echo "✓ yadm alternates applied"

# 4) Core Homebrew tools
echo "Installing core Homebrew tools..."
if [[ "$OS" == "Darwin" ]]; then
  # macOS: Install GUI-related tools
  brew tap homebrew/cask-fonts
  brew install yadm git git-delta
  brew install --cask font-jetbrains-mono-nerd-font
else
  # Linux: CLI tools only
  brew install yadm git git-delta
fi
echo "✓ Core tools installed"

# 5) Restore apps from Brewfile (YADM provides OS-specific version)
if [[ -f "$HOME/.Brewfile" ]]; then
  echo "Installing packages from Brewfile..."
  brew bundle --file "$HOME/.Brewfile"
  echo "✓ Brewfile packages installed"
fi

# 6) macOS-only: iTerm2 preferences
if [[ "$OS" == "Darwin" ]]; then
  echo "Configuring iTerm2..."
  mkdir -p "$HOME/.config/iterm2" "$HOME/Library/Application Support/iTerm2"
  defaults write com.googlecode.iterm2 PrefsCustomFolder -string "$HOME/.config/iterm2"
  defaults write com.googlecode.iterm2 LoadPrefsFromCustomFolder -bool true
  echo "✓ iTerm2 configured"
fi

# 7) Ubuntu/Debian-specific: Ghostty and fonts
if [[ "$OS" == "Linux" ]] && command -v apt >/dev/null 2>&1; then

  # Install Ghostty terminal via community .deb
  if ! command -v ghostty >/dev/null 2>&1; then
    echo "Installing Ghostty terminal..."
    if /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/mkasberg/ghostty-ubuntu/HEAD/install.sh)"; then
      echo "✓ Ghostty installed"
    else
      echo "⚠️  Ghostty installation failed - you may need to install it manually"
    fi
  else
    echo "✓ Ghostty already installed"
  fi

  # Install JetBrains Mono Nerd Font (optional - skip on failure)
  if [ ! -d "$HOME/.local/share/fonts/JetBrainsMono" ]; then
    echo "Installing JetBrains Mono Nerd Font (this may take a minute)..."
    mkdir -p "$HOME/.local/share/fonts/JetBrainsMono"

    # Download with timeout to prevent hanging
    if timeout 120 curl -fLo /tmp/JetBrainsMono.zip https://github.com/ryanoasis/nerd-fonts/releases/latest/download/JetBrainsMono.zip 2>/dev/null; then
      if unzip -q -o /tmp/JetBrainsMono.zip -d "$HOME/.local/share/fonts/JetBrainsMono/" 2>/dev/null; then
        rm -f /tmp/JetBrainsMono.zip
        fc-cache -fv >/dev/null 2>&1
        echo "✓ Nerd Font installed"
      else
        echo "⚠️  Font extraction failed - skipping (Ghostty has built-in icon support)"
        rm -f /tmp/JetBrainsMono.zip
        rm -rf "$HOME/.local/share/fonts/JetBrainsMono"
      fi
    else
      echo "⚠️  Font download timed out or failed - skipping (Ghostty has built-in icon support)"
      rm -f /tmp/JetBrainsMono.zip
      rm -rf "$HOME/.local/share/fonts/JetBrainsMono"
    fi
  else
    echo "✓ JetBrainsMono Nerd Font already installed"
  fi

  # Change default shell to zsh
  if [ "$SHELL" != "$(which zsh)" ]; then
    echo "Changing default shell to zsh..."
    if chsh -s "$(which zsh)"; then
      echo "✓ Shell changed to zsh (will take effect on next login)"
    else
      echo "⚠️  Failed to change shell - you may need to run: chsh -s \$(which zsh)"
    fi
  else
    echo "✓ Default shell is already zsh"
  fi
fi

# 8) GNOME-specific: Apply dconf settings
if [[ "$OS" == "Linux" ]] && [[ "${XDG_CURRENT_DESKTOP:-}" == *"GNOME"* ]]; then
  if [ -f "$HOME/.config/dconf/user.conf" ]; then
    echo "Restoring GNOME settings..."
    if dconf load / < "$HOME/.config/dconf/user.conf"; then
      echo "✓ GNOME settings restored"
    else
      echo "⚠️  GNOME settings restoration failed"
    fi
  fi
fi

echo ""
echo "=== Bootstrap complete! ==="
echo ""
echo "Next steps:"
if [[ "$OS" == "Linux" ]]; then
  echo "  1. Run: exec zsh"
  echo "  2. Verify: ghostty --version"
  echo "  3. Verify: oh-my-posh --version"
  echo ""
  echo "GPG/pinentry not configured - install manually if needed:"
  echo "  brew install gnupg pinentry-curses"
fi
echo ""
